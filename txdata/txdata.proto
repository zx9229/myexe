syntax = "proto3";

package txdata;

import public "google/protobuf/timestamp.proto";

enum MsgType {
    Zero1                =  0;
    ID_ConnectedData     =  1;
    ID_DisconnectedData  =  2;
    ID_CommonNtosReq     = 31;
    ID_CommonNtosRsp     = 32;
    ID_CommonStonReq     = 33;
    ID_CommonStoaRsp     = 34;
    ID_ExecuteCommandReq = 35;
    ID_ExecuteCommandRsp = 36;
}

enum ProgramType {
    Zero2  = 0;
    CLIENT = 1; //客户端
    SERVER = 2; //服务端
    NODE   = 3; //节点端
    POINT  = 4; //最末端的(采集点/受控点/等).
}

//必须是可见的ASCII字符,且不能为(/),这样可以拼成(/zone/node/type/name)的样子.
message AtomicKey {
    string      ZoneName = 1;//区域名(机房名)(区域级别,必须唯一).
    string      NodeName = 2;//节点名(机器名)(同一区域,必须唯一).
    ProgramType ExecType = 3;//程序类型.
    string      ExecName = 4;//程序名.(同一机器,必须唯一).
}

message ConnectionInfo {
    enum LinkType {
        Zero3   = 0;
        CONNECT = 1; //以client的身份,connect到server,建立起来的连接.
        ACCEPT  = 2; //以server的身份,accept,建立起来的连接.
    }
    AtomicKey UserKey   = 1;//由它的直属父亲检查数据合法性,检查通过之后,中转节点不再检查.
    string    UserID    = 2;
    AtomicKey BelongKey = 3;
    string    BelongID  = 4;
    string    Version   = 5;//版本号
    LinkType  LinkMode  = 6;//连接方向
    int32     ExePid    = 7;//进程ID
    string    ExePath   = 8;//程序路径
    string    Remark    = 9;
}

// 某user维护的所有连接,打包成一个结构体,作为一个快照,发送出去.
message ConnInfoSnap {
    string                  UserID = 1;
    repeated ConnectionInfo data   = 2;
}

message ConnectedData {
    ConnectionInfo  Info    = 1;
    repeated string Pathway = 2;//两者之间要按顺序走哪些AGENT
/* ParentA:(父亲agent), ParentC1:(父亲client1), SonA:(儿子agent), GrandsonA:(孙子agent)
ParentA
│  ParentC1               ParentA收到的Pathway=[]
│  ParentC2               ParentA收到的Pathway=[]
│
└─SonA                    ParentA收到的Pathway=[SonA]
    │  SonC1              ParentA收到的Pathway=[SonA]
    │  SonC2              ParentA收到的Pathway=[SonA]
    │
    └─GrandsonA           ParentA收到的Pathway=[GrandsonA,SonA]
            GrandsonC1    ParentA收到的Pathway=[GrandsonA,SonA]
            GrandsonC2    ParentA收到的Pathway=[GrandsonA,SonA]
*/
}

message DisconnectedData {
    ConnectionInfo  Info    = 1;
}

message CommonNtosReq {//通用请求(请求的方向是agentTOserver)
    int64                     RequestID  = 1;//(正:超时等待,要回响应);(零:不等待,不用回复响应);(负:背景上报,要回响应)
    string                    UserID     = 2;
    int64                     SeqNo      = 3;//(正:缓存数据,发不过去要重试)(零:未缓存数据,发不过去就算了)(负:绝无可能)
    bool                      Endeavour  = 4;//收不到服务器的响应就不罢休.
    string                    DataType   = 5;
    bytes                     Data       = 6;
    google.protobuf.Timestamp ReqTime    = 7;
}

message CommonNtosRsp {
    int64           RequestID = 1;
    repeated string Pathway   = 2;
    int64           SeqNo     = 3;//这个参数可以没有,我用它检查了数据,安心
    int32           ErrNo     = 4;//(ErrNo==0)表示SERVER处理成功,AGENT可以删除自己的缓存了.
    string          ErrMsg    = 5;//(ErrNo==0 && len(ErrMsg)==0)表示SERVER处理成功,同时没有任何警告,处理得非常完美.
}

message CommonStonReq {
    int64                     RequestID = 1;
    repeated string           Pathway   = 2;
    string                    DataType  = 3;
    bytes                     Data      = 4;
    google.protobuf.Timestamp ReqTime   = 5;//SERVER请求(网络/NET/NETWORK)的时候的本地时间戳.
}

message CommonStonRsp {
    int64                     RequestID = 1;
    string                    UserID    = 2;//这个参数可以没有,我用它检查了数据,安心.
    string                    DataType  = 3;
    bytes                     Data      = 4;
    google.protobuf.Timestamp RspTime   = 5;//(网络/NET/NETWORK)回应SERVER的时候的本地时间戳.
}

message ExecuteCommandReq {
    int64           RequestID = 1;
    repeated string Pathway   = 2;
    string          Command   = 3;
}

message ExecuteCommandRsp {
    int64           RequestID = 1;
    string          UserID    = 2;//这个参数可以没有,我用它检查了数据,安心
    string          Result    = 3;//结果.
    int32           ErrNo     = 4;
    string          ErrMsg    = 5;
}

message ReportDataItem {
    string Topic = 1;//Data的主题.
    string Data  = 2;
}

message SendMailItem {//发送邮件的项
    string Username    = 1;
    string Password    = 2;
    string SmtpAddr    = 3;
    string To          = 4;
    string Subject     = 5;
    string ContentType = 6;
    string Content     = 7;
}

message ServerCacheItem {
}
